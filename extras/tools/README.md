This directory (extra/tools) contains tools used by the authors of **libpng**.

Code and data placed in this directory is not required to build **libpng**, however the code in this directory has been used to generate data or code in the body of the **libpng** source.  The source code identifies where this has been done.  Code in this directory may not compile on all operating systems that **libpng** supports.

NO COPYRIGHT RIGHTS ARE CLAIMED TO ANY OF THE FILES IN THIS DIRECTORY.

To the extent possible under law, the authors have waived all copyright and related or neighboring rights to this work.  This work is published from: United States.

The files may be used freely in any way.

The source code and comments in this directory are the original work of the people named below.  No other person or organization has made contributions to the work in this directory.

### ORIGINAL AUTHORS
The following people have contributed to the code in this directory.  None of the people below claim any rights with regard to the contents of this directory.

- John Bowler (jbowler at acm.org)
- Glenn Randers-Pehrson (glennrp at users.sourceforge.net)

## checksum-icc.c
Generate crc32 and adler32 checksums of the given input files, used to generate check-codes for use when matching ICC profiles within **libpng**.

## convert.c
Convert 8-bit sRGB or 16-bit linear values to another format. Usage:

`convert [-linear|-sRGB] [-gray|-color] component{1,4}`

## cvtcolor.c
Convert 8-bit sRGB or 16-bit linear values to another format. Usage:

`cvtcolor [-linear|-sRGB] [-gray|-color] component{1,4}`

## genpng.c
Generate a PNG with an alpha channel, correctly.

This is a test case generator; the resultant PNG files are only of interest to those of us who care about whether the edges of circles are green, red, or yellow.

The program generates an RGB+Alpha PNG of a given size containing the given shapes on a transparent background. Usage:
```
genpng [--8bit] width height {<shape_spec>}...`
  <shape_spec> ::= <color> <width> <shape> <x1> <y1> <x2> <y2>
  <color> ::= black|white|red|green|yellow|blue|brown|purple|pink|orange|gray|cyan
  <shape> ::= circle|square|line
  <width> ::= filled|<number>
  <x1>    ::= <number>
  <x2>    ::= <number>
  <y1>    ::= <number>
  <y2>    ::= <number>
```

The point is to have colors that are linguistically meaningful plus that old bugbear of the department store dress murders, Cyan, the only color we argue about.

If `shape` is:
 - circle: draws an ellipse
 - square: draws a rectangle
 - line: draws a straight line

Each shape is followed by four numbers, these are two points in the output
coordinate space (as real numbers) which describe the circle, square, or
line.  The shape is filled if it is preceded by 'filled' (not valid for
'line') or is drawn with a line, in which case the width of the line must
precede the shape.

The whole set of information can be repeated as many times as desired:

The output PNG is generated by down-sampling a 4x supersampled image using
a bi-cubic filter.  The bi-cubic has a 2 (output) pixel width, so an 8x8
array of super-sampled points contribute to each output pixel.  The value of
a super-sampled point is found using an unfiltered, aliased, infinite
precision image: Each shape from the last to the first is checked to see if
the point is in the drawn area and, if it is, the color of the point is the
color of the shape and the alpha is 1, if not the previous shape is checked.

This is an aliased algorithm because no filtering is done; a point is either
inside or outside each shape and 'close' points do not contribute to the
sample.  The down-sampling is relied on to correct the error of not using
a filter.

The line end-caps are 'flat'; they go through the points.  The square line
joins are mitres; the outside of the lines are continued to the point of
intersection.

## intgamma
Shell script to generate `png.c` 8-bit and 16-bit log tables (see the code in `png.c` for details).

This script uses the `bc` arbitrary precision calculator to calculate 32-bit fixed point values of logarithms appropriate to finding the log of an 8-bit (0..255) value and a similar table for the exponent calculation.

`bc` must be on the path when the script is executed, and the math library (-lm) must be available.

## makesRGB.c
Make a table to convert 8-bit sRGB encoding values into the closest 16-bit linear value.

Make two tables to take a linear value scaled to 255*65535 and return an approximation to the 8-bit sRGB encoded value.  Calculate the error in these tables and display it.

## pngcp.c
This is an example of copying a PNG without changes using the `png_read_png` and `png_write_png` interfaces.  A considerable number of options are provided to manipulate the compression of the PNG data and other compressed chunks.

For a more extensive example that uses the transforms see [tests/pngimage.c](../../tests/pngimage.c) in the libpng distribution

## pngfix
Tests, optimizes and optionally fixes the `zlib` header in PNG files. Optionally, when fixing, strips ancillary chunks from the file.
By default files are just checked for readability with a summary of the of `zlib` issues founds for each compressed chunk and the IDAT stream in the file. Usage:
```
  pngfix [options] {files}
```
### Options:

OPERATION
- `--optimize` (-o):  Find the smallest deflate window size for the compressed data.
- `--strip`=`[none|crc|unsafe|unused|transform|color|all]`:  
  - `none` (default):   Retain all chunks.
  - `crc`:    Remove chunks with a bad CRC.
  - `unsafe`: Remove chunks that may be unsafe to retain if the image data is modified. This is set automatically if `--max` is given but may be cancelled by a later`--strip=none`.
  - `unused`: Remove chunks not used by **libpng** when decoding an image. This retainsany chunks that might be used by **libpng** image transformations.
  - `transform`: unused+bKGD.
  - `color`:  transform+iCCP and cHRM.
  - `all`:    color+gAMA and sRGB.
   
  Only ancillary chunks are ever removed.  In addition the _tRNS_ and _sBIT_ chunks are never removed as they affect exact interpretation of the image pixel values.  The following known chunks are treated specially by the above options:
    - _gAMA_, _sRGB_ `[all]`: These specify the gamma encoding used for the pixel values.
    - _cHRM_, _iCCP_ `[color]`: These specify how colors are encoded.  _iCCP_ also specifies the exact encoding of a pixel value; however, in practice most programs will ignore it.
    - _bKGD_ `[transform]`: This is used by **libpng** transforms.
  
- `--max=<number>`: Use IDAT chunks sized <number>.  If no number is given the IDAT chunks will be the maximum size permitted 2^31-1 bytes.  If the option is omitted the original chunk sizes will not be changed.  When the option is given `--strip=unsafe` is set automatically. This may be cancelled if you know that all unknown unsafe-to-copy chunks really are safe to copy across an IDAT size change.  This is true of all chunks that have ever been formally proposed as PNG extensions.
  
MESSAGES

By default the program only outputs summaries for each file.
- `--quiet (-q)`: Do not output the summaries except for files that cannot be read. With two `--quiet`s these are not output either.
- `--errors (-e)`: Output errors from **libpng** and the program (except too-far-back).
- `--warnings (-w)`: Output warnings from **libpng**.

OUTPUT

By default nothing is written.
- `--out=<file>`: Write the optimized/corrected version of the next PNG to `<file>`.  This overrides the following two options
- `--suffix=<suffix>`: Set `--out=<name><suffix>` for all following files unless overridden on a per-file basis by explicit `--out`.
- `--prefix=<prefix>`: Set `--out=<prefix><name>` for all the following files unless overridden on a per-file basis by explicit `--out`.

These two options can be used together to produce a suffix and prefix.

INTERNAL OPTIONS
- `--test`: Test the PNG_MAXIMUM_INFLATE_WINDOW option.  Setting this disables output as this would produce a broken file.

### Exit Codes
  *** SUBJECT TO CHANGE ***",
  
The program exit code is value in the range 0..127 holding a bit mask of the following codes.  Notice that the results for each file are combined together - check one file at a time to get a meaningful error code!
    
- 0x01: The **zlib** too-far-back error existed in at least one chunk.
- 0x02: At least one chunk had a CRC error.
- 0x04: A chunk length was incorrect.
- 0x08: The file was truncated.

Errors less than 16 are potentially recoverable, for a single file if the exit code is less than 16 the file could be read (with corrections if a non-zero code is returned).

- 0x10: The file could not be read, even with corrections.
- 0x20: The output file could not be written.
- 0x40: An unexpected, potentially internal, error occurred.

If the command line arguments are incorrect the program exits with exit 1.  Some older operating systems only support 7-bit exit codes, on those systems it is suggested that this program is first tested by supplying invalid arguments.

### Description
`pngfix` checks each PNG file on the command line for errors.  By default errors are not output and the program just returns an exit code and prints a summary. With the `--quiet (-q)` option the summaries are suppressed too and the program only outputs unexpected errors (internal errors and file open errors).

Various known problems in PNG files are fixed while the file is being read. The exit code says what problems were fixed.  In particular the **zlib** error:

>        "invalid distance too far back"

caused by an incorrect optimization of a **zlib** stream is fixed in any compressed chunk in which it is encountered.  An integrity problem of the PNG stream caused by a bug in **libpng** which wrote an incorrect chunk length is also fixed.  Chunk CRC errors are automatically fixed up.

Setting one of the "OUTPUT" options causes the possibly modified file to be written to a new file.

Notice that some PNG files with the **zlib** optimization problem can still be read by libpng under some circumstances.  This program will still detect and, if requested, correct the error.

The program will reliably process all files on the command line unless either an invalid argument causes the usage message (this message) to be produced or the program crashes.

The summary lines describe issues encountered with the **zlib** compressed stream of a chunk.  They have the following format, which is SUBJECT TO CHANGE in the future:
```
     chunk reason comp-level p1 p2 p3 p4 file
```
`p1` through `p4` vary according to the `reason`.  There are always 8 space separated fields.  Reasons specific formats are:
```
     chunk ERR status code read-errno write-errno message file
     chunk SKP comp-level file-bits zlib-rc compressed message file
     chunk ??? comp-level file-bits ok-bits compressed uncompress file
```
The various fields are:
1. `chunk`:      The chunk type of a chunk in the file or 'HEAD' if a problem is reported by libpng at the start of the IDAT stream.
   
2. `reason`:     One of:
    - `CHK`: A **zlib** header checksum was detected and fixed.
    - `TFB`: The **zlib** too far back error was detected and fixed.
    - `OK` : No errors were detected in the **zlib** stream and optimization was not requested, or was not possible.
    - `OPT`: The **zlib** stream window bits value could be improved (and was).
    - SKP: The chunk was skipped because of a zlib issue (zlib-rc) with explanation `message`,
    - `ERR`: The read of the file was aborted.  The parameters explain why.
  
3. `status`:  For `ERR` the accumulated status code from 'EXIT CODES' above. This is printed as a 2 digit hexadecimal value  
   `comp-level`: The recorded compression level (FLEVEL) of a **zlib** stream expressed as a string (supfast, stdfast, default, maximum)
  
4. `code`:  The file exit code; where stop was called, as a fairly terse string (warning, libpng, zlib, invalid, read, write, unexpected).  
   `file-bits`:  The **zlib** window bits recorded in the file.

5. `read-errno`: A system `errno` value from a read translated by `strerror`.
   zlib-rc:    A zlib return code as a string (see zlib.h).",
   ok-bits:    The smallest zlib window bits value that works.

6. `write-errno`: A system `errno` value from a write translated by `strerror`.  
   `compressed`: The count of compressed bytes in the **zlib** stream, when the reason is 'SKP'; this is a count of the bytes read from the stream when the fatal error was encountered.

7. `message`:  An error message (spaces replaced by _, as in all parameters), 
   `uncompress`: The count of bytes from uncompressing the **zlib** stream; this may not be the same as the number of bytes in the image.

8. `file`: The name of the file (this may contain spaces).

## png-fix-itxt.c
Fixes a PNG file written with `libpng-1.6.0` or `1.6.1` that has one or more uncompressed _iTXt_ chunks.  Assumes that the actual length is greater than or equal to the value in the length byte, and that the CRC is correct for the actual length.  This program hunts for the CRC and adjusts the length byte accordingly.  It is not an error to process a PNG file that has no _iTXt_ chunks or one that has valid _iTXt_ chunks; such files will simply be copied.

Usage:
```
  png-fix-itxt.exe < bad.png > good.png
```
